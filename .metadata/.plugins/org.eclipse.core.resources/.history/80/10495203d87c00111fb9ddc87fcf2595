package com.christine.cart;

import java.util.List;

import com.christine.cart.sqlite.Account;
import com.christine.cart.sqlite.AccountDatabaseHelper;
import com.christine.cart.sqlite.GroceryItem;
import com.christine.cart.sqlite.PreviousHistory;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.widget.TextView;

public class SummaryActivity extends Activity {
	
	TextView tv_summary;
	
	AccountDatabaseHelper adb;
	Account act;
	int days;
	String username;

	/** Called when the activity is first created. */
	@Override
	public void onCreate(Bundle savedInstanceState) {
	    super.onCreate(savedInstanceState);
	
	    setContentView(R.layout.summary);
	    
	   tv_summary = (TextView) findViewById(R.id.tv_summary);
	   
		Intent cartContents = getIntent();
		act = cartContents.getParcelableExtra("account");
		PreviousHistory pH = cartContents.getParcelableExtra("cartTotals");
		days = cartContents.getIntExtra("days", 1);
		username = act.getName();

		if (pH != null && act != null) {
			pH.setId(null);
			pH.setDays(days);

			// write to the previous history database, if the user doesn't
			// already exist in the db
			adb = new AccountDatabaseHelper(this);

			PreviousHistory existingHistory = adb.getPreviousHistoryFor(pH
					.getUsername());
			if (existingHistory.getCalories()!=0.0f) {
				adb.updatePreviousHistoryFor(pH);

				PreviousHistory thisHistory = adb
						.getPreviousHistoryFor(username);
				Log.d("CheckoutActivity",
						"PH updated, Name: " + thisHistory.getUsername()
								+ " Days: " + thisHistory.getDays()
								+ " Calories: " + thisHistory.getCalories());
			} else {
				adb.addPreviousHistoryFor(pH);

				PreviousHistory thisHistory = adb
						.getPreviousHistoryFor(username);
				Log.d("CheckoutActivity",
						"PH added, Name: " + thisHistory.getUsername()
								+ " Days: " + thisHistory.getDays()
								+ " Calories: " + thisHistory.getCalories());
			}

			// delete all of the current cart items based upon the username
			adb.deleteAllGroceryItemsOf(username);
			List<GroceryItem> gList = adb.getAllGroceryItemsOf(username);
			if (gList.size() == 0) {
				Log.d("CheckoutActivity", "Grocery items successfully cleared!");
			} else {
				Log.d("CheckoutActivity",
						"Grocery items still exist: " + gList.size());
			}

			adb.close();
		} else {
			tv_summary.setText("No Items in Cart");
		}
	}

}
