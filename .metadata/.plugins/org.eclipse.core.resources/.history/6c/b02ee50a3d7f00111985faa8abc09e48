/*
 * InputScanActivity 
 * 
 * Is an invisible activity that receives the contents of
 * the ZXING scan and searches for it in a UPC database 
 * in order to pass the name onto a database search.
 * 
 */
package com.christine.cart;

import java.net.URI;
import java.util.HashMap;

import org.xmlrpc.android.XMLRPCClient;
import org.xmlrpc.android.XMLRPCException;

import com.christine.cart.sqlite.Account;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;

public class InputScanActivity extends Activity {
	
	String contents;
	String upcResults;
	String resultDesc;
	//String resultMessage; //for debugging, see if scan was successful

	Context inputsContext;
	
	//for debug, see if contents are successfully returning an XML search
	//TextView outputText; 
	
	// XMLRPC library request arguments for upcdatabase.com
	private static URI uri=URI.create("http://www.upcdatabase.com/xmlrpc");
	private static String rpc_key="2cec7a0d6ee7bcdec8a3a12f48eda85052dfc0ab";
	private static XMLRPCClient client= new XMLRPCClient(uri);
	
	public static String[] ndbNames = new String[] { "CHEESE,COTTAGE,LOWFAT,2% MILKFAT", "EGG,WHL,RAW,FRSH", 
			"SNACKS,GRANOLA BAR,KASHI TLC BAR,CHEWY,MXD FLAVORS", "MILK,RED FAT,FLUID,2%MILKFAT,W/ ADDED VIT A & VIT D"};
	
	Account act;
	
	@Override
	public void onCreate(Bundle savedInstanceState) {
	    super.onCreate(savedInstanceState);
	    
	    //for debug, see if the contents are successfully returning an XML search
	    //setContentView(R.layout.search_barcode);
	    
	    inputsContext=getApplicationContext();
	    
	    contents = getIntent().getStringExtra("contents");
	    Account temp= getIntent().getParcelableExtra("account");
	    if(temp!=null){
	    	act = temp;
	    } else{
	    	throw new RuntimeException("InputSearchActivity, account is null");
	    }
	}
	
	public void onStart(){
		super.onStart();
		//search for the barcode's item in the XMLRPC library
		try {
			//for the XML-RPC, upcdatabase.com client
			HashMap<String, String> params = new HashMap<String, String>();
			params.put("rpc_key", rpc_key);
			params.put("upc", contents);
			HashMap result = (HashMap) client.call("lookup", params);
			System.out.println("This is contents " + contents);
			
			//store these values
			upcResults = result.toString();
			resultDesc = translateItemNameFromString(result.get("description").toString());
		}
		catch (NullPointerException nl) {
			nl.printStackTrace();
			Log.d("InputScanActivity", "Fail to return upc Results");
			
			// return the string for lookup in the ndb
			resultDesc = translateItemNameFromUPC(contents);
			return;
		} 
    	catch (XMLRPCException e) {
				e.printStackTrace();
				Log.d("InputScanActivity", "The search for the upc database retruned null.");
				
				// return the string for lookup in the ndb
				resultDesc = translateItemNameFromUPC(contents);
				return;
			}
		
		//for debug, see if the contents are successfully returning an XML search
		//outputText=(TextView) findViewById(R.id.outputText);
		//outputText.setText("UPC Results: " + upcResults);
		
		//start a new Intent to pass these values onto
		//the next invisible activity, which searches the database
		Intent databaseSearch=new Intent(inputsContext, InputDatabaseSearchActivity.class);
		databaseSearch.setType("text/plain");
		databaseSearch.addFlags(Intent.FLAG_ACTIVITY_NO_HISTORY);
		databaseSearch.putExtra("scanResult",contents); //This is the barcode reading
		databaseSearch.putExtra("resultDesc", resultDesc); //This is the name of the item
		databaseSearch.putExtra("account", act); //This is the account associated!
        startActivity(databaseSearch);
	}
	
	/**
	 * TRANSLATE ITEM NAME FROM UPC STRING TO NDB STRING
	 * A list of strings that are returned from the UPC database
	 * that will be forced to match the contents of an item within
	 * the database provided by the USDA
	 */
	public String translateItemNameFromString(String upcName){
		String ndbName = null;
		String[] upcNames = new String[] { "BRKSTONE M/F C/CHSE", "FARMHOUSE GRDE A LRG BRWN", 
				"Kashi 7 whole grains & Sesame Granola Bar (6 count)", "Lactaid Milk" };

		for(int i=0; i<upcNames.length; i++){
			if(upcName.equals(upcNames[i])){
				ndbName = ndbNames[i];  
			}
		}
		
		return ndbName;
	}
	
	/**
	 * TRANSLATE UPC CODE DIRECTLY TO NDB STRING
	 * In the case that the XML RPC database CANNOT be contacted on the day
	 * of the presentation, this method will provide matching strings for NDB
	 * based on the scanned number
	 */
	public String translateItemNameFromUPC(String upcScan){
		String ndbName = null;
		String[] upcCodes = new String[] { "021000123544" /*Breakstones*/, "028621123489" /*eggs*/, 
				"0018627030003" /*kashi bar*/, "0041383090721" /*lactaid*/, };
		
		for(int i=0; i<upcCodes.length; i++){
			if(upcScan.equals(upcCodes[i])){
				ndbName = ndbNames[i];  
			}
		}
		return ndbName;
	}

}
