package com.christine.cart;

import com.christine.cart.sqlite.Account;
import com.christine.cart.sqlite.AccountDatabaseHelper;
import com.christine.cart.sqlite.PreviousHistory;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;

public class CheckoutActivity extends Activity {
	Button newCart;
	Button logout;
	TextView cartTotals;
	
	AccountDatabaseHelper adb;
	Account act;
	int days;
	
	@Override
	public void onCreate(Bundle savedInstanceState) {
	    super.onCreate(savedInstanceState);
	    setContentView(R.layout.checkout);
	    
	    cartTotals = (TextView) findViewById(R.id.tv_cartTotal);
	    Intent cartContents = getIntent();
	    if(cartContents!=null){
	    	act = cartContents.getParcelableExtra("account");
	    	PreviousHistory pH = cartContents.getParcelableExtra("cartTotals");
	    	days = cartContents.getIntExtra("days", 1);
	    			
	    	pH.setId(null);
	    	pH.setDays(days);
	    	
	    	Log.d("CheckoutActivity", "Days: " + days);
	    	
	    	// write to the previous history database, if the user doesn't
	    	// already exist in the db
	    	adb = new AccountDatabaseHelper(this);
	    	
	    	PreviousHistory existingHistory = adb.getPreviousHistoryFor(pH.getUsername());
	    	if(existingHistory != null){
	    		cartTotals.setText("The user: " + existingHistory.getUsername() + "\n Days : " + existingHistory.getDays());
	    		
	    		adb.updatePreviousHistoryFor(pH);
	    		
	    		Log.d("PH update: ", "Previous History updated for " + pH.getUsername());
	    	} else{
	    		adb.addPreviousHistoryFor(pH);
	    		
	    		PreviousHistory thisHistory = adb.getPreviousHistoryFor(act.getName());
	    		Log.d("PH added: ", "PH added, Name: " + thisHistory.getUsername() + " Days: " + thisHistory.getDays() + "\n Calories: " + thisHistory.getCalories());
	    	}
	    	
	    	adb.close();
	    } else{
    		cartTotals.setText("No Items in Cart");
    	}
	    
	    newCart = (Button) findViewById(R.id.btn_newcart);
	    newCart.setOnClickListener(new View.OnClickListener() {
			public void onClick(View v) {
				Intent startNewCart = new Intent(CheckoutActivity.this, SetupPeopleActivity.class);
				startNewCart.putExtra("account", act);
				startNewCart.putExtra("username", act.getName());
				startActivity(startNewCart);
			}
		});
	    
	    logout = (Button) findViewById(R.id.btn_logout);
	    logout.setOnClickListener(new View.OnClickListener() {
			public void onClick(View v) {
				Intent logoutNow = new Intent(CheckoutActivity.this, StartActivity.class);
				startActivity(logoutNow);
			}
		});
	}

}
